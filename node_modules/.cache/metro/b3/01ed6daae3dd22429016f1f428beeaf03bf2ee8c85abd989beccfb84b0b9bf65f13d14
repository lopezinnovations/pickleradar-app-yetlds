{"dependencies":[{"name":"../types","data":{"asyncType":null,"isESMImport":true,"locs":[{"start":{"line":1,"column":0,"index":0},"end":{"line":1,"column":44,"index":44}}],"key":"SiqkZ9nARqNkdXfcIWbBgsKp5Yo=","exportNames":["*"],"imports":1}},{"name":"../incomplete","data":{"asyncType":null,"isESMImport":true,"locs":[{"start":{"line":2,"column":0,"index":45},"end":{"line":2,"column":73,"index":118}}],"key":"/hjTGdMdGgdeZBtl6GKfrqSaB4E=","exportNames":["*"],"imports":1}},{"name":"./logger","data":{"asyncType":null,"isESMImport":true,"locs":[{"start":{"line":3,"column":0,"index":119},"end":{"line":3,"column":54,"index":173}}],"key":"RJYKXaUuTbTmL7MuVmczbacEgjY=","exportNames":["*"],"imports":1}},{"name":"./processLines","data":{"asyncType":null,"isESMImport":true,"locs":[{"start":{"line":4,"column":0,"index":174},"end":{"line":4,"column":46,"index":220}}],"key":"D/yw/OI8wR5UMGoKmgUiZl3ntbc=","exportNames":["*"],"imports":1}},{"name":"./finalizeBlock","data":{"asyncType":null,"isESMImport":true,"locs":[{"start":{"line":5,"column":0,"index":221},"end":{"line":5,"column":48,"index":269}}],"key":"ZXEmh7WedEzZOLBEGxtfTAnbkWo=","exportNames":["*"],"imports":1}}],"output":[{"data":{"code":"__d(function (global, require, _$$_IMPORT_DEFAULT, _$$_IMPORT_ALL, module, exports, _dependencyMap) {\n  \"use strict\";\n\n  Object.defineProperty(exports, '__esModule', {\n    value: true\n  });\n  exports.processNewContent = processNewContent;\n  exports.resetRegistry = resetRegistry;\n  exports.finalizeActiveBlock = finalizeActiveBlock;\n  var _types = require(_dependencyMap[0], \"../types\");\n  var _incomplete = require(_dependencyMap[1], \"../incomplete\");\n  var _logger = require(_dependencyMap[2], \"./logger\");\n  var _processLines = require(_dependencyMap[3], \"./processLines\");\n  var _finalizeBlock = require(_dependencyMap[4], \"./finalizeBlock\");\n  const SPLITTER_VERSION = 'char-level-v1';\n  /**\n   * Process new content character-by-character.\n   *\n   * This ensures consistent block boundary detection regardless of chunk size.\n   * Whether content arrives 1 character at a time or 1000 characters at once,\n   * block boundaries are detected at the exact character position.\n   */\n  function processNewContent(registry, fullText) {\n    (0, _logger.logDebug)('processNewContent', {\n      previousCursor: registry.cursor,\n      incomingLength: fullText.length\n    });\n    (0, _logger.logStateSnapshot)('state.before', registry);\n    attachGlobalVersion();\n    if (fullText.length <= registry.cursor) {\n      return registry;\n    }\n    // Process each new character individually to ensure consistent\n    // block boundary detection regardless of chunk size\n    let currentRegistry = registry;\n    for (let i = registry.cursor; i < fullText.length; i++) {\n      // Process content up to position i+1 (one character at a time)\n      currentRegistry = processSingleCharacter(currentRegistry, fullText, i + 1);\n    }\n    (0, _logger.logStateSnapshot)('state.after', currentRegistry);\n    return currentRegistry;\n  }\n  /**\n   * Process content up to a specific position (single character increment).\n   * This is the core of character-level processing.\n   */\n  function processSingleCharacter(registry, fullText, endPos) {\n    // Only process if we have new content\n    if (endPos <= registry.cursor) {\n      return registry;\n    }\n    const newContent = fullText.slice(registry.cursor, endPos);\n    const activeContent = registry.activeBlock ? registry.activeBlock.content + newContent : newContent;\n    const newTagState = (0, _incomplete.updateTagState)(registry.activeTagState, activeContent);\n    const lines = activeContent.split('\\n');\n    // Create a virtual \"fullText\" that only goes up to endPos\n    // This ensures cursor is set correctly for this character\n    const virtualFullText = fullText.slice(0, endPos);\n    return (0, _processLines.processLines)({\n      registry,\n      fullText: virtualFullText,\n      lines,\n      activeContent,\n      tagState: newTagState,\n      activeStartPos: registry.activeBlock?.startPos ?? registry.cursor\n    });\n  }\n  function resetRegistry() {\n    return _types.INITIAL_REGISTRY;\n  }\n  /**\n   * Finalize the active block into a stable block.\n   * Call this when streaming is complete to ensure the last block is properly memoized.\n   */\n  function finalizeActiveBlock(registry) {\n    if (!registry.activeBlock || !registry.activeBlock.content.trim()) {\n      return registry;\n    }\n    const {\n      activeBlock\n    } = registry;\n    const type = activeBlock.type || 'paragraph';\n    const stableBlock = (0, _finalizeBlock.finalizeBlock)(activeBlock.content, type, registry.blockCounter, activeBlock.startPos);\n    return {\n      blocks: [...registry.blocks, stableBlock],\n      activeBlock: null,\n      activeTagState: _incomplete.INITIAL_INCOMPLETE_STATE,\n      cursor: registry.cursor,\n      blockCounter: registry.blockCounter + 1\n    };\n  }\n  function attachGlobalVersion() {\n    const target = typeof globalThis !== 'undefined' ? globalThis : typeof global !== 'undefined' ? global : undefined;\n    if (!target) return;\n    target.__streamdown = {\n      ...(target.__streamdown || {}),\n      splitterVersion: SPLITTER_VERSION\n    };\n  }\n});","lineCount":100,"map":[[7,2,14,0,"exports"],[7,9,14,0],[7,10,14,0,"processNewContent"],[7,27,14,0],[7,30,14,0,"processNewContent"],[7,47,14,0],[8,2,61,0,"exports"],[8,9,61,0],[8,10,61,0,"resetRegistry"],[8,23,61,0],[8,26,61,0,"resetRegistry"],[8,39,61,0],[9,2,68,0,"exports"],[9,9,68,0],[9,10,68,0,"finalizeActiveBlock"],[9,29,68,0],[9,32,68,0,"finalizeActiveBlock"],[9,51,68,0],[10,2,1,0],[10,6,1,0,"_types"],[10,12,1,0],[10,15,1,0,"require"],[10,22,1,0],[10,23,1,0,"_dependencyMap"],[10,37,1,0],[11,2,2,0],[11,6,2,0,"_incomplete"],[11,17,2,0],[11,20,2,0,"require"],[11,27,2,0],[11,28,2,0,"_dependencyMap"],[11,42,2,0],[12,2,3,0],[12,6,3,0,"_logger"],[12,13,3,0],[12,16,3,0,"require"],[12,23,3,0],[12,24,3,0,"_dependencyMap"],[12,38,3,0],[13,2,4,0],[13,6,4,0,"_processLines"],[13,19,4,0],[13,22,4,0,"require"],[13,29,4,0],[13,30,4,0,"_dependencyMap"],[13,44,4,0],[14,2,5,0],[14,6,5,0,"_finalizeBlock"],[14,20,5,0],[14,23,5,0,"require"],[14,30,5,0],[14,31,5,0,"_dependencyMap"],[14,45,5,0],[15,2,6,0],[15,8,6,6,"SPLITTER_VERSION"],[15,24,6,22],[15,27,6,25],[15,42,6,40],[16,2,7,0],[17,0,8,0],[18,0,9,0],[19,0,10,0],[20,0,11,0],[21,0,12,0],[22,0,13,0],[23,2,14,7],[23,11,14,16,"processNewContent"],[23,28,14,33,"processNewContent"],[23,29,14,34,"registry"],[23,37,14,42],[23,39,14,44,"fullText"],[23,47,14,52],[23,49,14,54],[24,4,15,4],[24,8,15,4,"logDebug"],[24,15,15,12],[24,16,15,12,"logDebug"],[24,24,15,12],[24,26,15,13],[24,45,15,32],[24,47,15,34],[25,6,16,8,"previousCursor"],[25,20,16,22],[25,22,16,24,"registry"],[25,30,16,32],[25,31,16,33,"cursor"],[25,37,16,39],[26,6,17,8,"incomingLength"],[26,20,17,22],[26,22,17,24,"fullText"],[26,30,17,32],[26,31,17,33,"length"],[27,4,18,4],[27,5,18,5],[27,6,18,6],[28,4,19,4],[28,8,19,4,"logStateSnapshot"],[28,15,19,20],[28,16,19,20,"logStateSnapshot"],[28,32,19,20],[28,34,19,21],[28,48,19,35],[28,50,19,37,"registry"],[28,58,19,45],[28,59,19,46],[29,4,20,4,"attachGlobalVersion"],[29,23,20,23],[29,24,20,24],[29,25,20,25],[30,4,21,4],[30,8,21,8,"fullText"],[30,16,21,16],[30,17,21,17,"length"],[30,23,21,23],[30,27,21,27,"registry"],[30,35,21,35],[30,36,21,36,"cursor"],[30,42,21,42],[30,44,21,44],[31,6,22,8],[31,13,22,15,"registry"],[31,21,22,23],[32,4,23,4],[33,4,24,4],[34,4,25,4],[35,4,26,4],[35,8,26,8,"currentRegistry"],[35,23,26,23],[35,26,26,26,"registry"],[35,34,26,34],[36,4,27,4],[36,9,27,9],[36,13,27,13,"i"],[36,14,27,14],[36,17,27,17,"registry"],[36,25,27,25],[36,26,27,26,"cursor"],[36,32,27,32],[36,34,27,34,"i"],[36,35,27,35],[36,38,27,38,"fullText"],[36,46,27,46],[36,47,27,47,"length"],[36,53,27,53],[36,55,27,55,"i"],[36,56,27,56],[36,58,27,58],[36,60,27,60],[37,6,28,8],[38,6,29,8,"currentRegistry"],[38,21,29,23],[38,24,29,26,"processSingleCharacter"],[38,46,29,48],[38,47,29,49,"currentRegistry"],[38,62,29,64],[38,64,29,66,"fullText"],[38,72,29,74],[38,74,29,76,"i"],[38,75,29,77],[38,78,29,80],[38,79,29,81],[38,80,29,82],[39,4,30,4],[40,4,31,4],[40,8,31,4,"logStateSnapshot"],[40,15,31,20],[40,16,31,20,"logStateSnapshot"],[40,32,31,20],[40,34,31,21],[40,47,31,34],[40,49,31,36,"currentRegistry"],[40,64,31,51],[40,65,31,52],[41,4,32,4],[41,11,32,11,"currentRegistry"],[41,26,32,26],[42,2,33,0],[43,2,34,0],[44,0,35,0],[45,0,36,0],[46,0,37,0],[47,2,38,0],[47,11,38,9,"processSingleCharacter"],[47,33,38,31,"processSingleCharacter"],[47,34,38,32,"registry"],[47,42,38,40],[47,44,38,42,"fullText"],[47,52,38,50],[47,54,38,52,"endPos"],[47,60,38,58],[47,62,38,60],[48,4,39,4],[49,4,40,4],[49,8,40,8,"endPos"],[49,14,40,14],[49,18,40,18,"registry"],[49,26,40,26],[49,27,40,27,"cursor"],[49,33,40,33],[49,35,40,35],[50,6,41,8],[50,13,41,15,"registry"],[50,21,41,23],[51,4,42,4],[52,4,43,4],[52,10,43,10,"newContent"],[52,20,43,20],[52,23,43,23,"fullText"],[52,31,43,31],[52,32,43,32,"slice"],[52,37,43,37],[52,38,43,38,"registry"],[52,46,43,46],[52,47,43,47,"cursor"],[52,53,43,53],[52,55,43,55,"endPos"],[52,61,43,61],[52,62,43,62],[53,4,44,4],[53,10,44,10,"activeContent"],[53,23,44,23],[53,26,44,26,"registry"],[53,34,44,34],[53,35,44,35,"activeBlock"],[53,46,44,46],[53,49,45,10,"registry"],[53,57,45,18],[53,58,45,19,"activeBlock"],[53,69,45,30],[53,70,45,31,"content"],[53,77,45,38],[53,80,45,41,"newContent"],[53,90,45,51],[53,93,46,10,"newContent"],[53,103,46,20],[54,4,47,4],[54,10,47,10,"newTagState"],[54,21,47,21],[54,24,47,24],[54,28,47,24,"updateTagState"],[54,39,47,38],[54,40,47,38,"updateTagState"],[54,54,47,38],[54,56,47,39,"registry"],[54,64,47,47],[54,65,47,48,"activeTagState"],[54,79,47,62],[54,81,47,64,"activeContent"],[54,94,47,77],[54,95,47,78],[55,4,48,4],[55,10,48,10,"lines"],[55,15,48,15],[55,18,48,18,"activeContent"],[55,31,48,31],[55,32,48,32,"split"],[55,37,48,37],[55,38,48,38],[55,42,48,42],[55,43,48,43],[56,4,49,4],[57,4,50,4],[58,4,51,4],[58,10,51,10,"virtualFullText"],[58,25,51,25],[58,28,51,28,"fullText"],[58,36,51,36],[58,37,51,37,"slice"],[58,42,51,42],[58,43,51,43],[58,44,51,44],[58,46,51,46,"endPos"],[58,52,51,52],[58,53,51,53],[59,4,52,4],[59,11,52,11],[59,15,52,11,"processLines"],[59,28,52,23],[59,29,52,23,"processLines"],[59,41,52,23],[59,43,52,24],[60,6,53,8,"registry"],[60,14,53,16],[61,6,54,8,"fullText"],[61,14,54,16],[61,16,54,18,"virtualFullText"],[61,31,54,33],[62,6,55,8,"lines"],[62,11,55,13],[63,6,56,8,"activeContent"],[63,19,56,21],[64,6,57,8,"tagState"],[64,14,57,16],[64,16,57,18,"newTagState"],[64,27,57,29],[65,6,58,8,"activeStartPos"],[65,20,58,22],[65,22,58,24,"registry"],[65,30,58,32],[65,31,58,33,"activeBlock"],[65,42,58,44],[65,44,58,46,"startPos"],[65,52,58,54],[65,56,58,58,"registry"],[65,64,58,66],[65,65,58,67,"cursor"],[66,4,59,4],[66,5,59,5],[66,6,59,6],[67,2,60,0],[68,2,61,7],[68,11,61,16,"resetRegistry"],[68,24,61,29,"resetRegistry"],[68,25,61,29],[68,27,61,32],[69,4,62,4],[69,11,62,11,"INITIAL_REGISTRY"],[69,17,62,27],[69,18,62,27,"INITIAL_REGISTRY"],[69,34,62,27],[70,2,63,0],[71,2,64,0],[72,0,65,0],[73,0,66,0],[74,0,67,0],[75,2,68,7],[75,11,68,16,"finalizeActiveBlock"],[75,30,68,35,"finalizeActiveBlock"],[75,31,68,36,"registry"],[75,39,68,44],[75,41,68,46],[76,4,69,4],[76,8,69,8],[76,9,69,9,"registry"],[76,17,69,17],[76,18,69,18,"activeBlock"],[76,29,69,29],[76,33,69,33],[76,34,69,34,"registry"],[76,42,69,42],[76,43,69,43,"activeBlock"],[76,54,69,54],[76,55,69,55,"content"],[76,62,69,62],[76,63,69,63,"trim"],[76,67,69,67],[76,68,69,68],[76,69,69,69],[76,71,69,71],[77,6,70,8],[77,13,70,15,"registry"],[77,21,70,23],[78,4,71,4],[79,4,72,4],[79,10,72,10],[80,6,72,12,"activeBlock"],[81,4,72,24],[81,5,72,25],[81,8,72,28,"registry"],[81,16,72,36],[82,4,73,4],[82,10,73,10,"type"],[82,14,73,14],[82,17,73,17,"activeBlock"],[82,28,73,28],[82,29,73,29,"type"],[82,33,73,33],[82,37,73,37],[82,48,73,48],[83,4,74,4],[83,10,74,10,"stableBlock"],[83,21,74,21],[83,24,74,24],[83,28,74,24,"finalizeBlock"],[83,42,74,37],[83,43,74,37,"finalizeBlock"],[83,56,74,37],[83,58,74,38,"activeBlock"],[83,69,74,49],[83,70,74,50,"content"],[83,77,74,57],[83,79,74,59,"type"],[83,83,74,63],[83,85,74,65,"registry"],[83,93,74,73],[83,94,74,74,"blockCounter"],[83,106,74,86],[83,108,74,88,"activeBlock"],[83,119,74,99],[83,120,74,100,"startPos"],[83,128,74,108],[83,129,74,109],[84,4,75,4],[84,11,75,11],[85,6,76,8,"blocks"],[85,12,76,14],[85,14,76,16],[85,15,76,17],[85,18,76,20,"registry"],[85,26,76,28],[85,27,76,29,"blocks"],[85,33,76,35],[85,35,76,37,"stableBlock"],[85,46,76,48],[85,47,76,49],[86,6,77,8,"activeBlock"],[86,17,77,19],[86,19,77,21],[86,23,77,25],[87,6,78,8,"activeTagState"],[87,20,78,22],[87,22,78,24,"INITIAL_INCOMPLETE_STATE"],[87,33,78,48],[87,34,78,48,"INITIAL_INCOMPLETE_STATE"],[87,58,78,48],[88,6,79,8,"cursor"],[88,12,79,14],[88,14,79,16,"registry"],[88,22,79,24],[88,23,79,25,"cursor"],[88,29,79,31],[89,6,80,8,"blockCounter"],[89,18,80,20],[89,20,80,22,"registry"],[89,28,80,30],[89,29,80,31,"blockCounter"],[89,41,80,43],[89,44,80,46],[90,4,81,4],[90,5,81,5],[91,2,82,0],[92,2,83,0],[92,11,83,9,"attachGlobalVersion"],[92,30,83,28,"attachGlobalVersion"],[92,31,83,28],[92,33,83,31],[93,4,84,4],[93,10,84,10,"target"],[93,16,84,16],[93,19,84,19],[93,26,84,26,"globalThis"],[93,36,84,36],[93,41,84,41],[93,52,84,52],[93,55,85,10,"globalThis"],[93,65,85,20],[93,68,86,10],[93,75,86,17,"global"],[93,81,86,23],[93,86,86,28],[93,97,86,39],[93,100,87,14,"global"],[93,106,87,20],[93,109,88,14,"undefined"],[93,118,88,23],[94,4,89,4],[94,8,89,8],[94,9,89,9,"target"],[94,15,89,15],[94,17,90,8],[95,4,91,4,"target"],[95,10,91,10],[95,11,91,11,"__streamdown"],[95,23,91,23],[95,26,91,26],[96,6,92,8],[96,10,92,12,"target"],[96,16,92,18],[96,17,92,19,"__streamdown"],[96,29,92,31],[96,33,92,35],[96,34,92,36],[96,35,92,37],[96,36,92,38],[97,6,93,8,"splitterVersion"],[97,21,93,23],[97,23,93,25,"SPLITTER_VERSION"],[98,4,94,4],[98,5,94,5],[99,2,95,0],[100,0,95,1],[100,3]],"functionMap":{"names":["<global>","processNewContent","processSingleCharacter","resetRegistry","finalizeActiveBlock","attachGlobalVersion"],"mappings":"AAA;OCa;CDmB;AEK;CFsB;OGC;CHE;OIK;CJc;AKC;CLY"},"hasCjsExports":false},"type":"js/module"}]}